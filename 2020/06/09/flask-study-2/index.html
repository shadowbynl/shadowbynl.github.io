<!DOCTYPE html>

<html lang="zh">

<head>
    
    <title>flask-study-2 - Memory</title>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="https://i.loli.net/2020/09/12/4y1TBOItE9w8WFq.png" type="image/x-icon" />
    <meta name="description" content="黑马ihome项目 其一">
<meta property="og:type" content="article">
<meta property="og:title" content="flask-study-2">
<meta property="og:url" content="https://shadowbynl.github.io/2020/06/09/flask-study-2/index.html">
<meta property="og:site_name" content="Memory">
<meta property="og:description" content="黑马ihome项目 其一">
<meta property="og:locale">
<meta property="article:published_time" content="2020-06-09T09:14:14.000Z">
<meta property="article:modified_time" content="2020-06-14T15:42:32.959Z">
<meta property="article:author" content="nlby">
<meta property="article:tag" content="PythonWeb">
<meta name="twitter:card" content="summary">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1633604899830">
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1633604899830">
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/nexmoe/nexmoe.github.io@latest/images/cover/5c3aec85a4343.jpg)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="nlby" class="mdui-btn mdui-btn-icon"><img src="https://i.loli.net/2020/09/12/4y1TBOItE9w8WFq.png" alt="nlby"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="nlby">
            <img src="https://i.loli.net/2020/09/12/4y1TBOItE9w8WFq.png" alt="nlby" alt="nlby">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>Articles</span>74</div>
        <div><span>Tags</span>13</div>
        <div><span>Categories</span>29</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
        
            <form id="search_form">
                <label><input class="st-default-search-input" id="search_value" name="q" type="search" placeholder="Search" style="
                    font-size: 15px !important;
                    height: 56px !important;
                    background-image: none;
                "></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/?_wv=1027&k=5CfKHun" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/33077945" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/shadowbynl/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Categories</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Flask/">Flask</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/ORM/">ORM</a>
          <span class="category-list-count">7</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Web框架/">Web框架</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/css/">css</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/java/">java</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/写法/">写法</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/功能点学习/">功能点学习</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/基础/">基础</a>
          <span class="category-list-count">20</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/大四/">大四</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/安全/">安全</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/容器/">容器</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/工具/">工具</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/工具使用/">工具使用</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/数据/">数据</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/数据可视化/">数据可视化</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/测试/">测试</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/爬虫/">爬虫</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/环境/">环境</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/知识点总结/">知识点总结</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/移动布局/">移动布局</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/算法/">算法</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/规划/">规划</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/记录/">记录</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/语法/">语法</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/随机/">随机</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/随笔/">随笔</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/随记/">随记</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/面试/">面试</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/项目/">项目</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/Go/" style="font-size: 16.67px;">Go</a> <a href="/tags/JavaWeb/" style="font-size: 20px;">JavaWeb</a> <a href="/tags/PythonWeb/" style="font-size: 15px;">PythonWeb</a> <a href="/tags/android/" style="font-size: 18.33px;">android</a> <a href="/tags/javase/" style="font-size: 10px;">javase</a> <a href="/tags/sql/" style="font-size: 10px;">sql</a> <a href="/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/" style="font-size: 11.67px;">专业课</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 13.33px;">前端</a> <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" style="font-size: 11.67px;">区块链</a> <a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 10px;">总结</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">正则表达式</a> <a href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" style="font-size: 10px;">版本控制</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
    </div>
    
  </div>

    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Archive</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a><span class="archive-list-count">23</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">51</span></li></ul>
    </div>
  </div>



    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2021 nlby
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><embed src="https://jxiaoc.github.io/animeMusic/demo.html" width="100%"/>
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 66.66666666666666%;"> 
              <img data-src="https://cdn.jsdelivr.net/gh/nexmoe/nexmoe.github.io@latest/images/cover/5c3aec85a4343.jpg" data-sizes="auto" alt="flask-study-2" class="lazyload">
              <h1>flask-study-2</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2020年06月09日</a>
    <a><i class="nexmoefont icon-areachart"></i>2.1k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 11 分钟</a>
</div>

      

      <p><strong>黑马ihome项目 其一</strong></p>
<span id="more"></span>
<p><strong>一、项目文件目录结构搭建</strong><br><strong>1.单一全依赖</strong><br>manage.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> CSRFProtect</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置信息&quot;&quot;&quot;</span></span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line">    SECRET_KEY = <span class="string">&quot;nlby33068080&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据库</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">&quot;mysql://root:6774258@127.0.0.1:3306/ihome_nlby&quot;</span></span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># redis</span></span><br><span class="line">    REDIS_HOST = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    REDIS_PORT = <span class="number">6379</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># flask-session配置</span></span><br><span class="line">    SESSION_TYPE = <span class="string">&quot;redis&quot;</span></span><br><span class="line">    SESSION_REDIS = redis.StrictRedis(host=REDIS_HOST, port=REDIS_PORT) <span class="comment"># 连接的redis实例</span></span><br><span class="line">    SESSION_USER_SIGNER = <span class="literal">True</span> <span class="comment"># 对cookie中session_id进行隐藏处理</span></span><br><span class="line">    PERMANENT_SESSION_LIFETIME = <span class="number">86400</span> <span class="comment"># session数据的有效期 单位秒</span></span><br><span class="line"></span><br><span class="line">app.config.from_object(Config)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库</span></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建redis连接对象</span></span><br><span class="line">redis_store = redis.StrictRedis(host=Config.REDIS_HOST, port=Config.REDIS_PORT)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用flask-session 将session数据保存到redis中</span></span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为flask补充csrf防护 只要有post请求 就需要crsf防护</span></span><br><span class="line">CSRFProtect(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/index&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p><strong>2.拆分–项目结构</strong><br>（一）工程根目录<br>manage.py 工程入口模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ihome <span class="keyword">import</span> create_app, db</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate, MigrateCommand</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建flask应用对象</span></span><br><span class="line">app = create_app(<span class="string">&quot;develop&quot;</span>)</span><br><span class="line">manager = Manager(app)</span><br><span class="line"></span><br><span class="line">Migrate(app, db)</span><br><span class="line">manager.add_command(<span class="string">&quot;db&quot;</span>, MigrateCommand)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure>
<p>config.py 配置类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置信息&quot;&quot;&quot;</span></span><br><span class="line">    SECRET_KEY = <span class="string">&quot;nlby33068080&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据库</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">&quot;mysql://root:6774258@127.0.0.1:3306/ihome_nlby&quot;</span></span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># redis</span></span><br><span class="line">    REDIS_HOST = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    REDIS_PORT = <span class="number">6379</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># flask-session配置</span></span><br><span class="line">    SESSION_TYPE = <span class="string">&quot;redis&quot;</span></span><br><span class="line">    SESSION_REDIS = redis.StrictRedis(host=REDIS_HOST, port=REDIS_PORT) <span class="comment"># 连接的redis实例</span></span><br><span class="line">    SESSION_USER_SIGNER = <span class="literal">True</span> <span class="comment"># 对cookie中session_id进行隐藏处理</span></span><br><span class="line">    PERMANENT_SESSION_LIFETIME = <span class="number">86400</span> <span class="comment"># session数据的有效期 单位秒</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DevelopmentConfig</span>(<span class="params">Config</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;开发环境的配置信息&quot;&quot;&quot;</span></span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductionConfig</span>(<span class="params">Config</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;生产环境的配置信息&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">config_map = &#123;</span><br><span class="line">    <span class="string">&quot;develop&quot;</span>: DevelopmentConfig,</span><br><span class="line">    <span class="string">&quot;product&quot;</span>: ProductionConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（二）工程实现包ihome<br><strong>init</strong>.py 进行所有的app初始化 设置用到的全局变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> CSRFProtect</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> logging.handlers <span class="keyword">import</span> RotatingFileHandler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库</span></span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建redis连接对象</span></span><br><span class="line">redis_store = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志信息</span></span><br><span class="line"><span class="comment"># 创建日志记录器，指明日志保存的路径、每个日志文件的最大大小、保存的日志文件个数上限</span></span><br><span class="line">file_log_handler = RotatingFileHandler(<span class="string">&quot;logs/log&quot;</span>, maxBytes=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">100</span>, backupCount=<span class="number">10</span>)</span><br><span class="line"><span class="comment"># 创建日志记录的格式                 日志等级    输入日志信息的文件名 行数    日志信息</span></span><br><span class="line">formatter = logging.Formatter(<span class="string">&#x27;%(levelname)s %(filename)s:%(lineno)d %(message)s&#x27;</span>)</span><br><span class="line"><span class="comment"># 为刚创建的日志记录器设置日志记录格式</span></span><br><span class="line">file_log_handler.setFormatter(formatter)</span><br><span class="line"><span class="comment"># 为全局的日志工具对象（flask app使用的）添加日记录器</span></span><br><span class="line">logging.getLogger().addHandler(file_log_handler)</span><br><span class="line"><span class="comment"># 设置日志的记录等级</span></span><br><span class="line">logging.basicConfig(level=logging.DEBUG)  <span class="comment"># 调试debug级</span></span><br><span class="line">logging.error(<span class="string">&quot;&quot;</span>) <span class="comment"># 错误级别</span></span><br><span class="line">logging.warn(<span class="string">&quot;&quot;</span>) <span class="comment"># 警告级别</span></span><br><span class="line">logging.info(<span class="string">&quot;&quot;</span>) <span class="comment"># 消息提示级别</span></span><br><span class="line">logging.debug(<span class="string">&quot;&quot;</span>) <span class="comment"># 调试级别</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 工厂模式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>(<span class="params">config_name</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    创建flask的应用对象</span></span><br><span class="line"><span class="string">    :param config_name: str 配置模式的名字 (&quot;develop&quot;, &quot;product&quot;)</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    <span class="comment"># 根据配置模式的名字获取配置参数的类</span></span><br><span class="line">    config_class = config_map.get(config_name)</span><br><span class="line">    app.config.from_object(config_class)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用app初始化db</span></span><br><span class="line">    db.init_app(app)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化redis工具</span></span><br><span class="line">    <span class="keyword">global</span> redis_store</span><br><span class="line">    redis_store = redis.StrictRedis(host=config_class.REDIS_HOST, port=config_class.REDIS_PORT)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 利用flask-session 将session数据保存到redis中</span></span><br><span class="line">    Session(app)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 为flask补充csrf防护 只要有post请求 就需要crsf防护</span></span><br><span class="line">    CSRFProtect(app)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> ihome <span class="keyword">import</span> api_1_0</span><br><span class="line">    <span class="comment"># 注册蓝图</span></span><br><span class="line">    app.register_blueprint(api_1_0.api, url_prefix=<span class="string">&quot;/api/v1.0&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<p>models.py 模型类模块<br>api_1_0 1.0蓝图的视图存放目录<br>api_1_0/<strong>init</strong>.py 1.0版本蓝图的创建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建蓝图对象</span></span><br><span class="line">api = Blueprint(<span class="string">&quot;api_1_0&quot;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入蓝图的视图</span></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> demo</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>api_1_0/views.py 1.0版本的视图函数模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> api</span><br><span class="line"></span><br><span class="line"><span class="meta">@api.route(<span class="params"><span class="string">&quot;/index&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>libs 存放外界依赖的目录<br>utils 工具包<br>static 静态资源文件<br>（三）logs 存放日志文件</p>
<p><strong>二、数据库设计</strong><br>1.数据库设计<br>2.根据设计创建模型类<br>3.迁移</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python manage.py db init</span><br><span class="line"></span><br><span class="line">python manage.py db migrate  -m <span class="string">&quot;init tables&quot;</span></span><br><span class="line"></span><br><span class="line">python manage.py db upgrade</span><br></pre></td></tr></table></figure>

<p><strong>三、静态文件接口</strong><br>1.前后端分离与不分离的方式<br>2.静态文件蓝图<br>3.csrf防护机制与生成</p>
<p><strong>四、图片验证码</strong><br>1.生成图片验证码的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># refer to `https://bitbucket.org/akorn/wheezy.captcha`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageFilter</span><br><span class="line"><span class="keyword">from</span> PIL.ImageDraw <span class="keyword">import</span> Draw</span><br><span class="line"><span class="keyword">from</span> PIL.ImageFont <span class="keyword">import</span> truetype</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bezier</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.tsequence = <span class="built_in">tuple</span>([t / <span class="number">20.0</span> <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>)])</span><br><span class="line">        self.beziers = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pascal_row</span>(<span class="params">self, n</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot; Returns n-th row of Pascal&#x27;s triangle</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        result = [<span class="number">1</span>]</span><br><span class="line">        x, numerator = <span class="number">1</span>, n</span><br><span class="line">        <span class="keyword">for</span> denominator <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, n // <span class="number">2</span> + <span class="number">1</span>):</span><br><span class="line">            x *= numerator</span><br><span class="line">            x /= denominator</span><br><span class="line">            result.append(x)</span><br><span class="line">            numerator -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> n &amp; <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">            result.extend(<span class="built_in">reversed</span>(result[:-<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result.extend(<span class="built_in">reversed</span>(result))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_bezier</span>(<span class="params">self, n</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot; Bezier curves:</span></span><br><span class="line"><span class="string">            http://en.wikipedia.org/wiki/B%C3%A9zier_curve#Generalization</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.beziers[n]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            combinations = self.pascal_row(n - <span class="number">1</span>)</span><br><span class="line">            result = []</span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> self.tsequence:</span><br><span class="line">                tpowers = (t ** i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n))</span><br><span class="line">                upowers = ((<span class="number">1</span> - t) ** i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>))</span><br><span class="line">                coefs = [c * a * b <span class="keyword">for</span> c, a, b <span class="keyword">in</span> <span class="built_in">zip</span>(combinations,</span><br><span class="line">                                                      tpowers, upowers)]</span><br><span class="line">                result.append(coefs)</span><br><span class="line">            self.beziers[n] = result</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Captcha</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self._bezier = Bezier()</span><br><span class="line">        self._<span class="built_in">dir</span> = os.path.dirname(__file__)</span><br><span class="line">        <span class="comment"># self._captcha_path = os.path.join(self._dir, &#x27;..&#x27;, &#x27;static&#x27;, &#x27;captcha&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">instance</span>():</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(Captcha, <span class="string">&quot;_instance&quot;</span>):</span><br><span class="line">            Captcha._instance = Captcha()</span><br><span class="line">        <span class="keyword">return</span> Captcha._instance</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">self, width=<span class="number">200</span>, height=<span class="number">75</span>, color=<span class="literal">None</span>, text=<span class="literal">None</span>, fonts=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="comment"># self.image = Image.new(&#x27;RGB&#x27;, (width, height), (255, 255, 255))</span></span><br><span class="line">        self._text = text <span class="keyword">if</span> text <span class="keyword">else</span> random.sample(string.ascii_uppercase + string.ascii_uppercase + <span class="string">&#x27;3456789&#x27;</span>, <span class="number">4</span>)</span><br><span class="line">        self.fonts = fonts <span class="keyword">if</span> fonts <span class="keyword">else</span> \</span><br><span class="line">            [os.path.join(self._<span class="built_in">dir</span>, <span class="string">&#x27;fonts&#x27;</span>, font) <span class="keyword">for</span> font <span class="keyword">in</span> [<span class="string">&#x27;Arial.ttf&#x27;</span>, <span class="string">&#x27;Georgia.ttf&#x27;</span>, <span class="string">&#x27;actionj.ttf&#x27;</span>]]</span><br><span class="line">        self.width = width</span><br><span class="line">        self.height = height</span><br><span class="line">        self._color = color <span class="keyword">if</span> color <span class="keyword">else</span> self.random_color(<span class="number">0</span>, <span class="number">200</span>, random.randint(<span class="number">220</span>, <span class="number">255</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">random_color</span>(<span class="params">start, end, opacity=<span class="literal">None</span></span>):</span></span><br><span class="line">        red = random.randint(start, end)</span><br><span class="line">        green = random.randint(start, end)</span><br><span class="line">        blue = random.randint(start, end)</span><br><span class="line">        <span class="keyword">if</span> opacity <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> red, green, blue</span><br><span class="line">        <span class="keyword">return</span> red, green, blue, opacity</span><br><span class="line"></span><br><span class="line">    <span class="comment"># draw image</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">background</span>(<span class="params">self, image</span>):</span></span><br><span class="line">        Draw(image).rectangle([(<span class="number">0</span>, <span class="number">0</span>), image.size], fill=self.random_color(<span class="number">238</span>, <span class="number">255</span>))</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">smooth</span>(<span class="params">image</span>):</span></span><br><span class="line">        <span class="keyword">return</span> image.<span class="built_in">filter</span>(ImageFilter.SMOOTH)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">curve</span>(<span class="params">self, image, width=<span class="number">4</span>, number=<span class="number">6</span>, color=<span class="literal">None</span></span>):</span></span><br><span class="line">        dx, height = image.size</span><br><span class="line">        dx /= number</span><br><span class="line">        path = [(dx * i, random.randint(<span class="number">0</span>, height))</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, number)]</span><br><span class="line">        bcoefs = self._bezier.make_bezier(number - <span class="number">1</span>)</span><br><span class="line">        points = []</span><br><span class="line">        <span class="keyword">for</span> coefs <span class="keyword">in</span> bcoefs:</span><br><span class="line">            points.append(<span class="built_in">tuple</span>(<span class="built_in">sum</span>([coef * p <span class="keyword">for</span> coef, p <span class="keyword">in</span> <span class="built_in">zip</span>(coefs, ps)])</span><br><span class="line">                                <span class="keyword">for</span> ps <span class="keyword">in</span> <span class="built_in">zip</span>(*path)))</span><br><span class="line">        Draw(image).line(points, fill=color <span class="keyword">if</span> color <span class="keyword">else</span> self._color, width=width)</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">noise</span>(<span class="params">self, image, number=<span class="number">50</span>, level=<span class="number">2</span>, color=<span class="literal">None</span></span>):</span></span><br><span class="line">        width, height = image.size</span><br><span class="line">        dx = width / <span class="number">10</span></span><br><span class="line">        width -= dx</span><br><span class="line">        dy = height / <span class="number">10</span></span><br><span class="line">        height -= dy</span><br><span class="line">        draw = Draw(image)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(number):</span><br><span class="line">            x = <span class="built_in">int</span>(random.uniform(dx, width))</span><br><span class="line">            y = <span class="built_in">int</span>(random.uniform(dy, height))</span><br><span class="line">            draw.line(((x, y), (x + level, y)), fill=color <span class="keyword">if</span> color <span class="keyword">else</span> self._color, width=level)</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">text</span>(<span class="params">self, image, fonts, font_sizes=<span class="literal">None</span>, drawings=<span class="literal">None</span>, squeeze_factor=<span class="number">0.75</span>, color=<span class="literal">None</span></span>):</span></span><br><span class="line">        color = color <span class="keyword">if</span> color <span class="keyword">else</span> self._color</span><br><span class="line">        fonts = <span class="built_in">tuple</span>([truetype(name, size)</span><br><span class="line">                       <span class="keyword">for</span> name <span class="keyword">in</span> fonts</span><br><span class="line">                       <span class="keyword">for</span> size <span class="keyword">in</span> font_sizes <span class="keyword">or</span> (<span class="number">65</span>, <span class="number">70</span>, <span class="number">75</span>)])</span><br><span class="line">        draw = Draw(image)</span><br><span class="line">        char_images = []</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> self._text:</span><br><span class="line">            font = random.choice(fonts)</span><br><span class="line">            c_width, c_height = draw.textsize(c, font=font)</span><br><span class="line">            char_image = Image.new(<span class="string">&#x27;RGB&#x27;</span>, (c_width, c_height), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">            char_draw = Draw(char_image)</span><br><span class="line">            char_draw.text((<span class="number">0</span>, <span class="number">0</span>), c, font=font, fill=color)</span><br><span class="line">            char_image = char_image.crop(char_image.getbbox())</span><br><span class="line">            <span class="keyword">for</span> drawing <span class="keyword">in</span> drawings:</span><br><span class="line">                d = <span class="built_in">getattr</span>(self, drawing)</span><br><span class="line">                char_image = d(char_image)</span><br><span class="line">            char_images.append(char_image)</span><br><span class="line">        width, height = image.size</span><br><span class="line">        offset = <span class="built_in">int</span>((width - <span class="built_in">sum</span>(<span class="built_in">int</span>(i.size[<span class="number">0</span>] * squeeze_factor)</span><br><span class="line">                                  <span class="keyword">for</span> i <span class="keyword">in</span> char_images[:-<span class="number">1</span>]) -</span><br><span class="line">                      char_images[-<span class="number">1</span>].size[<span class="number">0</span>]) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">for</span> char_image <span class="keyword">in</span> char_images:</span><br><span class="line">            c_width, c_height = char_image.size</span><br><span class="line">            mask = char_image.convert(<span class="string">&#x27;L&#x27;</span>).point(<span class="keyword">lambda</span> i: i * <span class="number">1.97</span>)</span><br><span class="line">            image.paste(char_image,</span><br><span class="line">                        (offset, <span class="built_in">int</span>((height - c_height) / <span class="number">2</span>)),</span><br><span class="line">                        mask)</span><br><span class="line">            offset += <span class="built_in">int</span>(c_width * squeeze_factor)</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="comment"># draw text</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">warp</span>(<span class="params">image, dx_factor=<span class="number">0.27</span>, dy_factor=<span class="number">0.21</span></span>):</span></span><br><span class="line">        width, height = image.size</span><br><span class="line">        dx = width * dx_factor</span><br><span class="line">        dy = height * dy_factor</span><br><span class="line">        x1 = <span class="built_in">int</span>(random.uniform(-dx, dx))</span><br><span class="line">        y1 = <span class="built_in">int</span>(random.uniform(-dy, dy))</span><br><span class="line">        x2 = <span class="built_in">int</span>(random.uniform(-dx, dx))</span><br><span class="line">        y2 = <span class="built_in">int</span>(random.uniform(-dy, dy))</span><br><span class="line">        image2 = Image.new(<span class="string">&#x27;RGB&#x27;</span>,</span><br><span class="line">                           (width + <span class="built_in">abs</span>(x1) + <span class="built_in">abs</span>(x2),</span><br><span class="line">                            height + <span class="built_in">abs</span>(y1) + <span class="built_in">abs</span>(y2)))</span><br><span class="line">        image2.paste(image, (<span class="built_in">abs</span>(x1), <span class="built_in">abs</span>(y1)))</span><br><span class="line">        width2, height2 = image2.size</span><br><span class="line">        <span class="keyword">return</span> image2.transform(</span><br><span class="line">            (width, height), Image.QUAD,</span><br><span class="line">            (x1, y1,</span><br><span class="line">             -x1, height2 - y2,</span><br><span class="line">             width2 + x2, height2 + y2,</span><br><span class="line">             width2 - x2, -y1))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">offset</span>(<span class="params">image, dx_factor=<span class="number">0.1</span>, dy_factor=<span class="number">0.2</span></span>):</span></span><br><span class="line">        width, height = image.size</span><br><span class="line">        dx = <span class="built_in">int</span>(random.random() * width * dx_factor)</span><br><span class="line">        dy = <span class="built_in">int</span>(random.random() * height * dy_factor)</span><br><span class="line">        image2 = Image.new(<span class="string">&#x27;RGB&#x27;</span>, (width + dx, height + dy))</span><br><span class="line">        image2.paste(image, (dx, dy))</span><br><span class="line">        <span class="keyword">return</span> image2</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rotate</span>(<span class="params">image, angle=<span class="number">25</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> image.rotate(</span><br><span class="line">            random.uniform(-angle, angle), Image.BILINEAR, expand=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">captcha</span>(<span class="params">self, path=<span class="literal">None</span>, fmt=<span class="string">&#x27;JPEG&#x27;</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Create a captcha.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            path: save path, default None.</span></span><br><span class="line"><span class="string">            fmt: image format, PNG / JPEG.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            A tuple, (name, text, StringIO.value).</span></span><br><span class="line"><span class="string">            For example:</span></span><br><span class="line"><span class="string">                (&#x27;fXZJN4AFxHGoU5mIlcsdOypa&#x27;, &#x27;JGW9&#x27;, &#x27;\x89PNG\r\n\x1a\n\x00\x00\x00\r...&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        image = Image.new(<span class="string">&#x27;RGB&#x27;</span>, (self.width, self.height), (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>))</span><br><span class="line">        image = self.background(image)</span><br><span class="line">        image = self.text(image, self.fonts, drawings=[<span class="string">&#x27;warp&#x27;</span>, <span class="string">&#x27;rotate&#x27;</span>, <span class="string">&#x27;offset&#x27;</span>])</span><br><span class="line">        image = self.curve(image)</span><br><span class="line">        image = self.noise(image)</span><br><span class="line">        image = self.smooth(image)</span><br><span class="line">        name = <span class="string">&quot;&quot;</span>.join(random.sample(string.ascii_lowercase + string.ascii_uppercase + <span class="string">&#x27;3456789&#x27;</span>, <span class="number">24</span>))</span><br><span class="line">        text = <span class="string">&quot;&quot;</span>.join(self._text)</span><br><span class="line">        out = BytesIO()</span><br><span class="line">        image.save(out, <span class="built_in">format</span>=fmt)</span><br><span class="line">        <span class="keyword">if</span> path:</span><br><span class="line">            image.save(os.path.join(path, name), fmt)</span><br><span class="line">        <span class="keyword">return</span> name, text, out.getvalue()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_captcha</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.initialize()</span><br><span class="line">        <span class="keyword">return</span> self.captcha(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">captcha = Captcha.instance()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span> (captcha.generate_captcha())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2.获取图片验证码的逻辑</p>
<p><strong>五、短信验证码</strong><br>1.云通讯sdk使用<br>参考 <a target="_blank" rel="noopener" href="https://blog.csdn.net/kk907528318/article/details/98250009">https://blog.csdn.net/kk907528318/article/details/98250009</a><br><a target="_blank" rel="noopener" href="https://www.yuntongxun.com/">https://www.yuntongxun.com/</a><br>2.短信验证码相关的逻辑</p>
<p><strong>六、注册登录 个人信息</strong><br>1.密码加密方法<br>2.csrf设置<br>3.登录验证装饰器<br>4.使用七牛云sdk上传图片<br>5.修改用户名<br>6.获取个人资料<br>7.实名认证</p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>Author：</strong>nlby<br>
        <strong>Link：</strong><a href="https://shadowbynl.github.io/2020/06/09/flask-study-2/" title="https:&#x2F;&#x2F;shadowbynl.github.io&#x2F;2020&#x2F;06&#x2F;09&#x2F;flask-study-2&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;shadowbynl.github.io&#x2F;2020&#x2F;06&#x2F;09&#x2F;flask-study-2&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/Flask/">Flask</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/PythonWeb/" rel="tag">PythonWeb</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'f8845ecb71eab90181fe',
        clientSecret: '6852a4d3526507b2d6b2d34ad72dc98438196ae8',
        id: window.location.pathname,
        repo: 'lts-blog-comments',
        owner: 'shadowbynl',
        admin: 'shadowbynl'
    })
    gitalk.render('gitalk')
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1633604899835"></script>

<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/violet.model.json"},"display":{"position":"left","width":180,"height":360},"mobile":{"show":true},"log":false});</script></body>

</html>
